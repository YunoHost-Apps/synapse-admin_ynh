#!/bin/bash

source _common.sh
source /usr/share/yunohost/helpers

#=================================================
# ENSURE DOWNWARD COMPATIBILITY
#=================================================
ynh_script_progression "Ensuring downward compatibility..."

if ynh_app_upgrading_from_version_before_or_equal_to 0.8.3~ynh2; then
    ynh_die "Upgrade from version 0.8.3 is not possible. You must uninstall and reinstall Synapse-admin package manually"
fi

# If synapse_app doesn't exist, create it and assume it is `synapse`
# FIXMEhelpers2.1: maybe replace with: ynh_app_setting_set_default --key=synapse_app --value="synapse"
if [ -z "${synapse_app:-}" ]; then
    synapse_app="synapse"
    ynh_app_setting_set --key=synapse_app --value=$synapse_app
fi

# Delete service and nodejs dependencies
if ynh_app_upgrading_from_version_before 0.8.7~ynh1; then
    yunohost service remove $app
    ynh_config_remove_systemd

    ynh_nodejs_remove
    ynh_config_remove_logrotate

    ynh_app_setting_delete --key=synapse_port
    ynh_app_setting_delete --key=port
fi

if ynh_app_upgrading_from_version_before 0.8.7~ynh3; then
    ynh_app_setting_delete --key=synapse_domain
    ynh_app_setting_delete --key=synapse_port
fi

#=================================================
# DOWNLOAD, CHECK AND UNPACK SOURCE
#=================================================

# FIXME: this is still supported but the recommendation is now to *always* re-setup the app sources wether or not the upstream sources changed
if ynh_app_upstream_version_changed; then
    ynh_script_progression "Upgrading source files..."

    ynh_setup_source --dest_dir="$install_dir"
fi

#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chmod -R o-rwx "$install_dir"
#REMOVEME? Assuming the install dir is setup using ynh_setup_source, the proper chmod/chowns are now already applied and it shouldn't be necessary to tweak perms | chown -R $app:www-data "$install_dir"
#=================================================
# REAPPLY SYSTEM CONFIGURATIONS
#=================================================
ynh_script_progression "Upgrading system configurations related to $app..."

# Create a dedicated nginx config
ynh_config_add_nginx
_add_synapse_endpoint_nginx_config

#=================================================
# END OF SCRIPT
#=================================================

ynh_script_progression "Upgrade of $app completed"
